{% extends "bootstrap/base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block title %}
	{% if title %}
		{{ title }} - {{ _('MicroBuluo') }}
	{% else %}
	{{ _('Welcome to MicroBuluo') }}
	{% endif %}
{% endblock %}

{% block navbar %}
	<nav class="navbar navbar-default">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>


				<a class="navbar-brand" href="{{ url_for('main.index') }}">{{ _('MicroBuluo') }}</a>
			</div>
                
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        {% if current_user.is_authenticated %}
				<ul class="nav navbar-nav">
					<li class="{% if explore or index %}active{% endif %}"><a href="{{ url_for('main.explore') }}">{{ _('Public Homepage') }}</a></li>
          <li class="{% if space %} active{% endif %}"><a href="{{ url_for('main.space') }}">{{ _('Personal Homepage') }}</a></li>

				</ul> 
        {% endif %}
        {% if g.search_form %}
                <form class="navbar-form navbar-left" method="get"
                        action="{{ url_for('main.search') }}">
                    <div class="form-group">
                        {{ g.search_form.q(size=20, class='form-control',
                            placeholder=g.search_form.q.label.text) }}
                    </div>
                </form>	
        {% endif %}
				<ul class="nav navbar-nav navbar-right">
					{% if current_user.is_anonymous %}
          {% if login %}
          <div class="form-group navbar-form navbar-left">
            {{ wtf.quick_form(form) }}
            </div>
            {% endif %}
            {% if register %}
						<li><a href="{{ url_for('auth.login') }}">{{ _('Login') }}</a></li>
            {% endif %}
					{% else %}
						<li>
							<a href="{{ url_for('main.messages') }}">
								{{ _('Messages') }}
								{% set unread_message_count = current_user.unread_message_count() %}
                            {% if unread_message_count %}
                            <span id="message_count" class="badge"
                                  style="visibility: {% if unread_message_count %}visible{% else %} hidden {% endif %};">
                                {{ unread_message_count }}
                            </span>
                            {% endif %}
							</a>
						</li>
						{% if current_user.can(Permission.MODERATE) %}
						<li><a href="{{ url_for('main.moderate') }}">{{ _('Moderate Comments') }}</a></li>
						{% endif %}
						<li><a href="{{ url_for('main.user', username=current_user.username) }}">{{ _('Profile') }}</a></li>
						<li><a href="{{ url_for('auth.logout') }}">{{ _('Logout') }}</a></li>
					{% endif %}
				</ul>
			</div>
		</div>
	</nav>
{% endblock %}

{% block content %}
	<div class="container">
		{% if current_user.is_authenticated %}
        {% with tasks = current_user.get_tasks_in_progress() %}
        {% if tasks %}
            {% for task in tasks %}
            <div class="alert alert-success" role="alert">
                {{ task.description }}
                <span id="{{ task.id }}-progress">{{ task.get_progress() }}</span>%
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}
        {% endif %}
		{% with messages = get_flashed_messages() %}
			{% if messages %}
				{% for message in messages %}
					<div class="alert alert-info" role="alert">{{ message }}</div>
				{% endfor %}
			{% endif %}
		{% endwith %}

		{# application content needs to be provided in the app_content block #}
		{% block app_content %}{% endblock %}
	</div>
{% endblock %}


{% block style %}
<!--这个语句将保留基础模板中的内容-->
{{ super() }}


{% endblock %}

{% block scripts %}
<!--这个语句将保留基础模板中的内容-->
{{ super() }}

{{ moment.include_moment() }}

{{ moment.lang(g.locale) }}

{{ moment.locale(auto_detect=True) }}

	<!--<script src="{{ url_for('static',filename='/popper.js') }}" ></script>-->
	<script src="{{ url_for('static',filename='/bootstrap.bundle.min.js') }}" ></script>
	
	<!-- 引入 jQuery -->
	<script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
	 
	<!-- 引入 Popper.js -->
	<script src="https://cdn.staticfile.org/popper.js/1.16.0/umd/popper.min.js"></script>

	

  <script>
    // ...

	function initialize_popovers() {
        const popups = document.getElementsByClassName('user_popup');
	
        for (let i = 0; i < popups.length; i++) {
			const popover = new bootstrap.Popover(popups[i], {
            content: 'Loading...',
            trigger: 'hover focus',
            placement: 'right',
            html: true,
            sanitize: false,
            delay: {show: 500, hide: 0},
            container: popups[i],
            customClass: 'd-inline',
          });
		  popups[i].addEventListener('show.bs.popover', async (ev) => {
            if (ev.target.popupLoaded) {
              return;
            }
            const response = await fetch('/user/' + ev.target.innerText.trim() + '/popup');
			
            const data = await response.text();
            const popover = bootstrap.Popover.getInstance(ev.target);
			console.log(popover)
            if (popover && data) {
              ev.target.popupLoaded = true;
              popover.setContent({'.popover-body': data});
              flask_moment_render_all
            }
			popover.show()
          });
        }
      }
      document.addEventListener('DOMContentLoaded', initialize_popovers);

	  function set_message_count(n) {
      const count = document.getElementById('message_count');
	  if(count == null){
		
	  }else{
      count.innerHTML = n;
      count.style.visibility = n ? 'visible' : 'hidden';
	}
    }

	{% if current_user.is_authenticated %}
    function initialize_notifications() {
      let since = 0;
      setInterval(async function() {
        const response = await fetch('{{ url_for('main.notifications') }}?since=' + since);
        const notifications = await response.json();
        for (let i = 0; i < notifications.length; i++) {
        switch (notifications[i].name) {
                case 'unread_message_count':
                  set_message_count(notifications[i].data);
                  break;
                case 'task_progress':
                  set_task_progress(notifications[i].data.task_id,
                      notifications[i].data.progress);
                  break;
              }
          since = notifications[i].timestamp;
        }
      }, 1000);
    }
    document.addEventListener('DOMContentLoaded', initialize_notifications);
    {% endif %}


	function set_task_progress(task_id, progress) {
            const progressElement = document.getElementById(task_id + '-progress');
            if (progressElement) {
                progressElement.innerText = progress;
            }
        }

  </script>
{% endblock %}